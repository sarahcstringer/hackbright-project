{% extends 'base.html' %}
{% block content %}

<script>

// Create the map to display 

function initialize() {

// Function to remove markers when a new view loads
    function removeMarkers(){
    for(i=0; i<markers.length; i++){
        markers[i].setMap(null);
    }
  }
// Function to bind info windows to markers
  function bindInfoWindow(marker, map, infoWindow, html) {
    google.maps.event.addListener(marker, 'click', function () {
      infoWindow.close();
      infoWindow.setContent(html);
      infoWindow.open(map, marker);
    });
  }

  function addMarkers(data) {
// Change the header date to the new date, one day earlier
    
    var bounds = new google.maps.LatLngBounds();
    {{session['home_lat']}}
    var home = new google.maps.LatLng({{session['home_lat']}},{{session['home_long']}})
    bounds.extend(home)
    var infoWindow = new google.maps.InfoWindow({
    width: 150
    });

    $('#displayDate').html(data.date);
    $('#logs').html('')
    removeMarkers();

    var log, marker, htmlInfo, htmlDiv;

    // Sort the logs by time

    // var numLogs = [Object.keys(data.logs)];
    // console.log(numLogs[0])
    // numLogs = numLogs[0]
    // var test2 = []
    // for (var i = 0; i < numLogs.length; i++) {
    //   test2.push(data.logs[numLogs[i]].arrived)
    //   }
    
    // console.log(test2.sort())

    for (var i = 0; i<data.logs.length; i++) {
      log = data.logs[i];

      var newDiv = document.createElement('div');
      newDiv.id = log.log_id

      htmlDiv = ('<div class="'+ log.locationId + '">' +
        '<p><b>Title: </b>' + log.title + '</p>' +
        '<p>Location: '+log.locationName +'</p>' +
        '<p><b>Date: </b>' + log.visitDate + '</p>' +
        '<p>Arrived: ' + log.arrived + '</p>' +
        '<p>Departed: ' + log.departed + '</p>' + 
        '<p>Comments: ' + log.comments + '</p>' +
        '<button style="display:inline" class="editDivButton" id="editdiv'+log.log_id+'">Edit</button></div>'
        );

      htmlInfo = ('<div>' +
        '<p><b>Name: </b>' + log.locationName + '</p>' +
        '<p>Address: ' + log.locationAddress + '</p>' +
        '</div><button style="display:inline" class = "editInfoButton" id="editinfo'+log.log_id+'">Edit</button>'
        );

      newDiv.innerHTML = htmlDiv;

      $('#logs').append(newDiv);

      marker = new google.maps.Marker({
        position: new google.maps.LatLng(log.locationLat, log.locationLong),
        map: map,
        title: log.locationName,
        animation: google.maps.Animation.DROP
        });

        google.maps.event.addListener(marker, 'click', function() {
          $('.'+this.metadata['id']).fadeToggle()})

      marker.metadata = {type: "point", id: log.locationId};
      markers.push(marker);
      bounds.extend(marker.position)
      bindInfoWindow(marker, map, infoWindow, htmlInfo)
    }

    // setting boundaries of map; if there are no locations logged, setting zoom to 10 and
    // centering on home location
      if (((bounds['H']['H'] != {{session['home_lat']}}) && (bounds['H']['j'] != {{session['home_long']}})) || ((bounds['j']['H'] != {{session['home_lat']}}) && (bounds['j']['j'] != {{session['home_long']}}))) {
        map.fitBounds(bounds);
    } else {
      map.setZoom(10)
      map.setCenter(home)
    }
    bounds = [];
  };


// Creating map properties
  var mapProp = {
    center:new google.maps.LatLng({{session['home_lat']}},{{session['home_long']}}),
    zoom:10,
    mapTypeId:google.maps.MapTypeId.ROADMAP
  };
  // Creating map variable
  var map=new google.maps.Map(document.getElementById("map"),mapProp);

  var markers = [];


// When page loads:
$( document ).ready(function() {
  $.get('/load_today', addMarkers)
});


$('#previous-day').on('click', function() {
  var changeDatePrev = {'showDate': $('#displayDate').html()};
  $.post('/change-previous-day', changeDatePrev, addMarkers) })

$('#next-day').on('click', function() {
  var changeDateNext = {'showDate': $('#displayDate').html()};
  $.post('/change-next-day', changeDateNext, addMarkers)
  });
  };


google.maps.event.addDomListener(window, 'load', initialize);


</script>

<!-- Create logout button -->
<form action='/logout' style='display:inline'>
<input type='submit' value='Logout'>
</form>
<button style='display:inline' name='viewProfile' id='viewProfile'>View Profile</button>

<!-- Profile info for user -->
<h1>Welcome back, {{ user.fname }}</h1>
<h3>Where have you been today?</h3>
<br>
<!-- User can move back a day or forward a day -->
<button id='previous-day' style='display:inline' name='previous-day'>Previous Day</button>
<h3 style='display:inline' id='displayDate'>{{ current_date }}</h3>
<button style='display:inline' id='next-day' name='next-day'>Next Day</button>

<!-- <div ng-app="embeddedApp">
<app.controller('MyController', function($scope)

rzslider rz-slider-model="slider.minValue"
          rz-slider-high="slider.maxValue"
          rz-slider-options="slider.options"></rzslider>
</div> -->
<!-- <script>
angular.module('slider', [])
  .controller('SlideController', function ($scope) {
  $scope.slider = {
      minValue: 10,
      maxValue: 90,
      options: {
          floor: 0,
          ceil: 100,
          step: 1
      }
  };
})
</script> -->

<div id="map"></div>

<button id='addLocation' name='addLocation'>Add Location</button>
<button id='viewLocations' name='viewLocations'>View All Locations</button>

<!-- When page loads, show the logs for that day -->

<div id='logs'>

</div>


<!-- Button to create new log (sends to different page) -->
<script>
var username = "{{session['user']}}";
    $('#addLocation').on('click', function(){
    $.post('/set-date', {'date': $('#displayDate').html()}, function(data) {
      window.location.href = ('/profile/'+username+'/add-location')})
  })

$('#viewLocations').on('click', function() {
  window.location.href = ('/profile/'+username+'/view-locations');
})
</script>


<script>
  
    $('#viewProfile').on('click', function() {
        window.location.href = ('/profile/{{session["user"]}}/view-profile');
    })


</script>



{% endblock %}